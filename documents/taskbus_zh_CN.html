<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>taskbus_zh_CN.html</title>
  <meta name="generator" content="Haroopad 0.13.1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>div.oembedall-githubrepos{border:1px solid #DDD;border-radius:4px;list-style-type:none;margin:0 0 10px;padding:8px 10px 0;font:13.34px/1.4 helvetica,arial,freesans,clean,sans-serif;width:452px;background-color:#fff}div.oembedall-githubrepos .oembedall-body{background:-moz-linear-gradient(center top,#FAFAFA,#EFEFEF);background:-webkit-gradient(linear,left top,left bottom,from(#FAFAFA),to(#EFEFEF));border-bottom-left-radius:4px;border-bottom-right-radius:4px;border-top:1px solid #EEE;margin-left:-10px;margin-top:8px;padding:5px 10px;width:100%}div.oembedall-githubrepos h3{font-size:14px;margin:0;padding-left:18px;white-space:nowrap}div.oembedall-githubrepos p.oembedall-description{color:#444;font-size:12px;margin:0 0 3px}div.oembedall-githubrepos p.oembedall-updated-at{color:#888;font-size:11px;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats{border:none;float:right;font-size:11px;font-weight:700;padding-left:15px;position:relative;z-index:5;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats li{border:none;color:#666;display:inline-block;list-style-type:none;margin:0!important}div.oembedall-githubrepos ul.oembedall-repo-stats li a{background-color:transparent;border:none;color:#666!important;background-position:5px -2px;background-repeat:no-repeat;border-left:1px solid #DDD;display:inline-block;height:21px;line-height:21px;padding:0 5px 0 23px}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a{border-left:medium none;margin-right:-3px}div.oembedall-githubrepos ul.oembedall-repo-stats li a:hover{background:5px -27px no-repeat #4183C4;color:#FFF!important;text-decoration:none}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a:hover{border-bottom-left-radius:3px;border-top-left-radius:3px}ul.oembedall-repo-stats li:last-child a:hover{border-bottom-right-radius:3px;border-top-right-radius:3px}span.oembedall-closehide{background-color:#aaa;border-radius:2px;cursor:pointer;margin-right:3px}div.oembedall-container{margin-top:5px;text-align:left}.oembedall-ljuser{font-weight:700}.oembedall-ljuser img{vertical-align:bottom;border:0;padding-right:1px}.oembedall-stoqembed{border-bottom:1px dotted #999;float:left;overflow:hidden;width:730px;line-height:1;background:#FFF;color:#000;font-family:Arial,Liberation Sans,DejaVu Sans,sans-serif;font-size:80%;text-align:left;margin:0;padding:0}.oembedall-stoqembed a{color:#07C;text-decoration:none;margin:0;padding:0}.oembedall-stoqembed a:hover{text-decoration:underline}.oembedall-stoqembed a:visited{color:#4A6B82}.oembedall-stoqembed h3{font-family:Trebuchet MS,Liberation Sans,DejaVu Sans,sans-serif;font-size:130%;font-weight:700;margin:0;padding:0}.oembedall-stoqembed .oembedall-reputation-score{color:#444;font-size:120%;font-weight:700;margin-right:2px}.oembedall-stoqembed .oembedall-user-info{height:35px;width:185px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-gravatar32{float:left;height:32px;width:32px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-details{float:left;margin-left:5px;overflow:hidden;white-space:nowrap;width:145px}.oembedall-stoqembed .oembedall-question-hyperlink{font-weight:700}.oembedall-stoqembed .oembedall-stats{background:#EEE;margin:0 0 0 7px;padding:4px 7px 6px;width:58px}.oembedall-stoqembed .oembedall-statscontainer{float:left;margin-right:8px;width:86px}.oembedall-stoqembed .oembedall-votes{color:#555;padding:0 0 7px;text-align:center}.oembedall-stoqembed .oembedall-vote-count-post{font-size:240%;color:#808185;display:block;font-weight:700}.oembedall-stoqembed .oembedall-views{color:#999;padding-top:4px;text-align:center}.oembedall-stoqembed .oembedall-status{margin-top:-3px;padding:4px 0;text-align:center;background:#75845C;color:#FFF}.oembedall-stoqembed .oembedall-status strong{color:#FFF;display:block;font-size:140%}.oembedall-stoqembed .oembedall-summary{float:left;width:635px}.oembedall-stoqembed .oembedall-excerpt{line-height:1.2;margin:0;padding:0 0 5px}.oembedall-stoqembed .oembedall-tags{float:left;line-height:18px}.oembedall-stoqembed .oembedall-tags a:hover{text-decoration:none}.oembedall-stoqembed .oembedall-post-tag{background-color:#E0EAF1;border-bottom:1px solid #3E6D8E;border-right:1px solid #7F9FB6;color:#3E6D8E;font-size:90%;line-height:2.4;margin:2px 2px 2px 0;padding:3px 4px;text-decoration:none;white-space:nowrap}.oembedall-stoqembed .oembedall-post-tag:hover{background-color:#3E6D8E;border-bottom:1px solid #37607D;border-right:1px solid #37607D;color:#E0EAF1}.oembedall-stoqembed .oembedall-fr{float:right}.oembedall-stoqembed .oembedall-statsarrow{background-image:url(http://cdn.sstatic.net/stackoverflow/img/sprites.png?v=3);background-repeat:no-repeat;overflow:hidden;background-position:0 -435px;float:right;height:13px;margin-top:12px;width:7px}.oembedall-facebook1{border:1px solid #1A3C6C;padding:0;font:13.34px/1.4 verdana;width:500px}.oembedall-facebook2{background-color:#627add}.oembedall-facebook2 a{color:#e8e8e8;text-decoration:none}.oembedall-facebookBody{background-color:#fff;vertical-align:top;padding:5px}.oembedall-facebookBody .contents{display:inline-block;width:100%}.oembedall-facebookBody div img{float:left;margin-right:5px}div.oembedall-lanyard{-webkit-box-shadow:none;-webkit-transition-delay:0s;-webkit-transition-duration:.4000000059604645s;-webkit-transition-property:width;-webkit-transition-timing-function:cubic-bezier(0.42,0,.58,1);background-attachment:scroll;background-clip:border-box;background-color:transparent;background-image:none;background-origin:padding-box;border-width:0;box-shadow:none;color:#112644;display:block;float:left;font-family:'Trebuchet MS',Trebuchet,sans-serif;font-size:16px;height:253px;line-height:19px;margin:0;max-width:none;min-height:0;outline:#112644 0;overflow-x:visible;overflow-y:visible;padding:0;position:relative;text-align:left;vertical-align:baseline;width:804px}div.oembedall-lanyard .tagline{font-size:1.5em}div.oembedall-lanyard .wrapper{overflow:hidden;clear:both}div.oembedall-lanyard .split{float:left;display:inline}div.oembedall-lanyard .prominent-place .flag:active,div.oembedall-lanyard .prominent-place .flag:focus,div.oembedall-lanyard .prominent-place .flag:hover,div.oembedall-lanyard .prominent-place .flag:link,div.oembedall-lanyard .prominent-place .flag:visited{float:left;display:block;width:48px;height:48px;position:relative;top:-5px;margin-right:10px}div.oembedall-lanyard .place-context{font-size:.889em}div.oembedall-lanyard .prominent-place .sub-place{display:block}div.oembedall-lanyard .prominent-place{font-size:1.125em;line-height:1.1em;font-weight:400}div.oembedall-lanyard .main-date{color:#8CB4E0;font-weight:700;line-height:1.1}div.oembedall-lanyard .first{width:48.57%;margin:0 0 0 2.857%}.mermaid .label{color:#333}.node circle,.node polygon,.node rect{fill:#cde498;stroke:#13540c;stroke-width:1px}.edgePath .path{stroke:green;stroke-width:1.5px}.cluster rect{fill:#cdffb2;rx:40;stroke:#6eaa49;stroke-width:1px}.cluster text{fill:#333}.actor{stroke:#13540c;fill:#cde498}text.actor{fill:#000;stroke:none}.actor-line{stroke:grey}.messageLine0{stroke-width:1.5;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#333}.messageLine1{stroke-width:1.5;stroke-dasharray:"2 2";stroke:#333}#arrowhead{fill:#333}#crosshead path{fill:#333!important;stroke:#333!important}.messageText{fill:#333;stroke:none}.labelBox{stroke:#326932;fill:#cde498}.labelText,.loopText{fill:#000;stroke:none}.loopLine{stroke-width:2;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#326932}.note{stroke:#6eaa49;fill:#fff5ad}.noteText{fill:#000;stroke:none;font-family:'trebuchet ms',verdana,arial;font-size:14px}.section{stroke:none;opacity:.2}.section0,.section2{fill:#6eaa49}.section1,.section3{fill:#fff;opacity:.2}.sectionTitle0,.sectionTitle1,.sectionTitle2,.sectionTitle3{fill:#333}.sectionTitle{text-anchor:start;font-size:11px;text-height:14px}.grid .tick{stroke:lightgrey;opacity:.3;shape-rendering:crispEdges}.grid path{stroke-width:0}.today{fill:none;stroke:red;stroke-width:2px}.task{stroke-width:2}.taskText{text-anchor:middle;font-size:11px}.taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px}.taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}.taskText0,.taskText1,.taskText2,.taskText3{fill:#fff}.task0,.task1,.task2,.task3{fill:#487e3a;stroke:#13540c}.taskTextOutside0,.taskTextOutside1,.taskTextOutside2,.taskTextOutside3{fill:#000}.active0,.active1,.active2,.active3{fill:#cde498;stroke:#13540c}.activeText0,.activeText1,.activeText2,.activeText3{fill:#000!important}.done0,.done1,.done2,.done3{stroke:grey;fill:lightgrey;stroke-width:2}.doneText0,.doneText1,.doneText2,.doneText3{fill:#000!important}.crit0,.crit1,.crit2,.crit3{stroke:#f88;fill:red;stroke-width:2}.activeCrit0,.activeCrit1,.activeCrit2,.activeCrit3{stroke:#f88;fill:#cde498;stroke-width:2}.doneCrit0,.doneCrit1,.doneCrit2,.doneCrit3{stroke:#f88;fill:lightgrey;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}.activeCritText0,.activeCritText1,.activeCritText2,.activeCritText3,.doneCritText0,.doneCritText1,.doneCritText2,.doneCritText3{fill:#000!important}.titleText{text-anchor:middle;font-size:18px;fill:#000}text{font-family:'trebuchet ms',verdana,arial;font-size:14px}html{height:100%}body{margin:0!important;padding:5px 20px 26px!important;background-color:#fff;font-family:"Lucida Grande","Segoe UI","Apple SD Gothic Neo","Malgun Gothic","Lucida Sans Unicode",Helvetica,Arial,sans-serif;font-size:.9em;overflow-x:hidden;overflow-y:auto}br,h1,h2,h3,h4,h5,h6{clear:both}hr.page{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x;border:0;height:3px;padding:0}hr.underscore{border-top-style:dashed!important}body >:first-child{margin-top:0!important}img.plugin{box-shadow:0 1px 3px rgba(0,0,0,.1);border-radius:3px}iframe{border:0}figure{-webkit-margin-before:0;-webkit-margin-after:0;-webkit-margin-start:0;-webkit-margin-end:0}kbd{border:1px solid #aaa;-moz-border-radius:2px;-webkit-border-radius:2px;border-radius:2px;-moz-box-shadow:1px 2px 2px #ddd;-webkit-box-shadow:1px 2px 2px #ddd;box-shadow:1px 2px 2px #ddd;background-color:#f9f9f9;background-image:-moz-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-o-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-webkit-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:linear-gradient(top,#eee,#f9f9f9,#eee);padding:1px 3px;font-family:inherit;font-size:.85em}.oembeded .oembed_photo{display:inline-block}img[data-echo]{margin:25px 0;width:100px;height:100px;background:url(../img/ajax.gif) center center no-repeat #fff}.spinner{display:inline-block;width:10px;height:10px;margin-bottom:-.1em;border:2px solid rgba(0,0,0,.5);border-top-color:transparent;border-radius:100%;-webkit-animation:spin 1s infinite linear;animation:spin 1s infinite linear}.spinner:after{content:'';display:block;width:0;height:0;position:absolute;top:-6px;left:0;border:4px solid transparent;border-bottom-color:rgba(0,0,0,.5);-webkit-transform:rotate(45deg);transform:rotate(45deg)}@-webkit-keyframes spin{to{-webkit-transform:rotate(360deg)}}@keyframes spin{to{transform:rotate(360deg)}}p.toc{margin:0!important}p.toc ul{padding-left:10px}p.toc>ul{padding:10px;margin:0 10px;display:inline-block;border:1px solid #ededed;border-radius:5px}p.toc li,p.toc ul{list-style-type:none}p.toc li{width:100%;padding:0;overflow:hidden}p.toc li a::after{content:"."}p.toc li a:before{content:"• "}p.toc h5{text-transform:uppercase}p.toc .title{float:left;padding-right:3px}p.toc .number{margin:0;float:right;padding-left:3px;background:#fff;display:none}input.task-list-item{margin-left:-1.62em}.markdown{font-family:"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Lucida Grande","Lucida Sans Unicode","Lucida Sans",'Segoe UI',AppleSDGothicNeo-Medium,'Malgun Gothic',Verdana,Tahoma,sans-serif;padding:20px}.markdown a{text-decoration:none;vertical-align:baseline}.markdown a:hover{text-decoration:underline}.markdown h1{font-size:2.2em;font-weight:700;margin:1.5em 0 1em}.markdown h2{font-size:1.8em;font-weight:700;margin:1.275em 0 .85em}.markdown h3{font-size:1.6em;font-weight:700;margin:1.125em 0 .75em}.markdown h4{font-size:1.4em;font-weight:700;margin:.99em 0 .66em}.markdown h5{font-size:1.2em;font-weight:700;margin:.855em 0 .57em}.markdown h6{font-size:1em;font-weight:700;margin:.75em 0 .5em}.markdown h1+p,.markdown h1:first-child,.markdown h2+p,.markdown h2:first-child,.markdown h3+p,.markdown h3:first-child,.markdown h4+p,.markdown h4:first-child,.markdown h5+p,.markdown h5:first-child,.markdown h6+p,.markdown h6:first-child{margin-top:0}.markdown hr{border:1px solid #ccc}.markdown p{margin:1em 0;word-wrap:break-word}.markdown ol{list-style-type:decimal}.markdown li{display:list-item;line-height:1.4em}.markdown blockquote{margin:1em 20px}.markdown blockquote>:first-child{margin-top:0}.markdown blockquote>:last-child{margin-bottom:0}.markdown blockquote cite:before{content:'\2014 \00A0'}.markdown .code{border-radius:3px;word-wrap:break-word}.markdown pre{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;overflow:auto;padding:.5em}.markdown pre code{border:0;display:block}.markdown pre>code{font-family:Consolas,Inconsolata,Courier,monospace;font-weight:700;white-space:pre;margin:0}.markdown code{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;padding:0 5px;margin:0 2px}.markdown img{max-width:100%}.markdown mark{color:#000;background-color:#fcf8e3}.markdown table{padding:0;border-collapse:collapse;border-spacing:0;margin-bottom:16px}.markdown table tr td,.markdown table tr th{border:1px solid #ccc;margin:0;padding:6px 13px}.markdown table tr th{font-weight:700}.markdown table tr th>:first-child{margin-top:0}.markdown table tr th>:last-child{margin-bottom:0}.markdown table tr td>:first-child{margin-top:0}.markdown table tr td>:last-child{margin-bottom:0}@import url(http://fonts.googleapis.com/css?family=Roboto+Condensed:300italic,400italic,700italic,400,300,700);.haroopad{padding:20px;color:#222;font-size:15px;font-family:"Roboto Condensed",Tauri,"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Lucida Grande","Lucida Sans Unicode","Lucida Sans",'Segoe UI',AppleSDGothicNeo-Medium,'Malgun Gothic',Verdana,Tahoma,sans-serif;background:#fff;line-height:1.6;-webkit-font-smoothing:antialiased}.haroopad a{color:#3269a0}.haroopad a:hover{color:#4183c4}.haroopad h2{border-bottom:1px solid #e6e6e6}.haroopad h6{color:#777}.haroopad hr{border:1px solid #e6e6e6}.haroopad blockquote>code,.haroopad h1>code,.haroopad h2>code,.haroopad h3>code,.haroopad h4>code,.haroopad h5>code,.haroopad h6>code,.haroopad li>code,.haroopad p>code,.haroopad td>code{font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;font-size:85%;background-color:rgba(0,0,0,.02);padding:.2em .5em;border:1px solid #efefef}.haroopad pre>code{font-size:1em;letter-spacing:-1px;font-weight:700}.haroopad blockquote{border-left:4px solid #e6e6e6;padding:0 15px;color:#777}.haroopad table{background-color:#fafafa}.haroopad table tr td,.haroopad table tr th{border:1px solid #e6e6e6}.haroopad table tr:nth-child(2n){background-color:#f2f2f2}.hljs{display:block;overflow-x:auto;padding:.5em;background:#fdf6e3;color:#657b83;-webkit-text-size-adjust:none}.diff .hljs-header,.hljs-comment,.hljs-doctype,.hljs-javadoc,.hljs-pi,.lisp .hljs-string{color:#93a1a1}.css .hljs-tag,.hljs-addition,.hljs-keyword,.hljs-request,.hljs-status,.hljs-winutils,.method,.nginx .hljs-title{color:#859900}.hljs-command,.hljs-dartdoc,.hljs-hexcolor,.hljs-link_url,.hljs-number,.hljs-phpdoc,.hljs-regexp,.hljs-rules .hljs-value,.hljs-string,.hljs-tag .hljs-value,.tex .hljs-formula{color:#2aa198}.css .hljs-function,.hljs-built_in,.hljs-chunk,.hljs-decorator,.hljs-id,.hljs-identifier,.hljs-localvars,.hljs-title,.vhdl .hljs-literal{color:#268bd2}.hljs-attribute,.hljs-class .hljs-title,.hljs-constant,.hljs-link_reference,.hljs-parent,.hljs-type,.hljs-variable,.lisp .hljs-body,.smalltalk .hljs-number{color:#b58900}.css .hljs-pseudo,.diff .hljs-change,.hljs-attr_selector,.hljs-cdata,.hljs-header,.hljs-pragma,.hljs-preprocessor,.hljs-preprocessor .hljs-keyword,.hljs-shebang,.hljs-special,.hljs-subst,.hljs-symbol,.hljs-symbol .hljs-string{color:#cb4b16}.hljs-deletion,.hljs-important{color:#dc322f}.hljs-link_label{color:#6c71c4}.tex .hljs-formula{background:#eee8d5}.MathJax_Hover_Frame{border-radius:.25em;-webkit-border-radius:.25em;-moz-border-radius:.25em;-khtml-border-radius:.25em;box-shadow:0 0 15px #83A;-webkit-box-shadow:0 0 15px #83A;-moz-box-shadow:0 0 15px #83A;-khtml-box-shadow:0 0 15px #83A;border:1px solid #A6D!important;display:inline-block;position:absolute}.MathJax_Hover_Arrow{position:absolute;width:15px;height:11px;cursor:pointer}#MathJax_About{position:fixed;left:50%;width:auto;text-align:center;border:3px outset;padding:1em 2em;background-color:#DDD;color:#000;cursor:default;font-family:message-box;font-size:120%;font-style:normal;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;border-radius:15px;-webkit-border-radius:15px;-moz-border-radius:15px;-khtml-border-radius:15px;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_Menu{position:absolute;background-color:#fff;color:#000;width:auto;padding:2px;border:1px solid #CCC;margin:0;cursor:default;font:menu;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_MenuItem{padding:2px 2em;background:0 0}.MathJax_MenuArrow{position:absolute;right:.5em;color:#666}.MathJax_MenuActive .MathJax_MenuArrow{color:#fff}.MathJax_MenuArrow.RTL{left:.5em;right:auto}.MathJax_MenuCheck{position:absolute;left:.7em}.MathJax_MenuCheck.RTL{right:.7em;left:auto}.MathJax_MenuRadioCheck{position:absolute;left:1em}.MathJax_MenuRadioCheck.RTL{right:1em;left:auto}.MathJax_MenuLabel{padding:2px 2em 4px 1.33em;font-style:italic}.MathJax_MenuRule{border-top:1px solid #CCC;margin:4px 1px 0}.MathJax_MenuDisabled{color:GrayText}.MathJax_MenuActive{background-color:Highlight;color:HighlightText}.MathJax_Menu_Close{position:absolute;width:31px;height:31px;top:-15px;left:-15px}#MathJax_Zoom{position:absolute;background-color:#F0F0F0;overflow:auto;display:block;z-index:301;padding:.5em;border:1px solid #000;margin:0;font-weight:400;font-style:normal;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;box-shadow:5px 5px 15px #AAA;-webkit-box-shadow:5px 5px 15px #AAA;-moz-box-shadow:5px 5px 15px #AAA;-khtml-box-shadow:5px 5px 15px #AAA;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}#MathJax_ZoomOverlay{position:absolute;left:0;top:0;z-index:300;display:inline-block;width:100%;height:100%;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}#MathJax_ZoomFrame{position:relative;display:inline-block;height:0;width:0}#MathJax_ZoomEventTrap{position:absolute;left:0;top:0;z-index:302;display:inline-block;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}.MathJax_Preview{color:#888}#MathJax_Message{position:fixed;left:1px;bottom:2px;background-color:#E6E6E6;border:1px solid #959595;margin:0;padding:2px 8px;z-index:102;color:#000;font-size:80%;width:auto;white-space:nowrap}#MathJax_MSIE_Frame{position:absolute;top:0;left:0;width:0;z-index:101;border:0;margin:0;padding:0}.MathJax_Error{color:#C00;font-style:italic}footer{position:fixed;font-size:.8em;text-align:right;bottom:0;margin-left:-25px;height:20px;width:100%}</style>
</head>
<body class="markdown haroopad">
<h1 id="taskbus(兔巴士)---一个跨平台的多进程合作框架"><a name="taskbus(兔巴士)---一个跨平台的多进程合作框架" href="#taskbus(兔巴士)---一个跨平台的多进程合作框架"></a>Taskbus(兔巴士) - 一个跨平台的多进程合作框架</h1><p><img src="file:///U:/taskBus/taskBus/taskbusplatform/images/taskBus.png" alt="TaskBusLogo"></p><p class="toc" style="undefined"></p><ul>
<li><ul>
<li><span class="title">
<a href="#1.-什么是taskbus" title="1. 什么是Taskbus">1. 什么是Taskbus</a>
</span>
<!--span class="number">
0
</span-->
</li>
<li><span class="title">
<a href="#2.-关键特性" title="2. 关键特性">2. 关键特性</a>
</span>
<!--span class="number">
1
</span-->
</li>
<li><span class="title">
<a href="#3.-基本原理" title="3. 基本原理">3. 基本原理</a>
</span>
<!--span class="number">
2
</span-->
<ul>
<li><span class="title">
<a href="#3.1-输入输出" title="3.1 输入输出">3.1 输入输出</a>
</span>
<!--span class="number">
3
</span-->
</li>
<li><span class="title">
<a href="#3.2-专题与通路" title="3.2 专题与通路">3.2 专题与通路</a>
</span>
<!--span class="number">
4
</span-->
<ul>
<li><span class="title">
<a href="#3.2.1-专题" title="3.2.1 专题">3.2.1 专题</a>
</span>
<!--span class="number">
5
</span-->
</li>
<li><span class="title">
<a href="#3.2.2-通路" title="3.2.2 通路">3.2.2 通路</a>
</span>
<!--span class="number">
6
</span-->
</li>
</ul>
</li>
<li><span class="title">
<a href="#3.3-带有专题和通路的io" title="3.3 带有专题和通路的IO">3.3 带有专题和通路的IO</a>
</span>
<!--span class="number">
7
</span-->
</li>
<li><span class="title">
<a href="#3.4-模块功能发布" title="3.4 模块功能发布">3.4 模块功能发布</a>
</span>
<!--span class="number">
8
</span-->
</li>
<li><span class="title">
<a href="#3.5-命令行参数" title="3.5 命令行参数">3.5 命令行参数</a>
</span>
<!--span class="number">
9
</span-->
</li>
<li><span class="title">
<a href="#3.6-第一个hello-world-模块的代码" title="3.6 第一个Hello-world 模块的代码">3.6 第一个Hello-world 模块的代码</a>
</span>
<!--span class="number">
10
</span-->
</li>
</ul>
</li>
<li><span class="title">
<a href="#4.-开发指南" title="4. 开发指南">4. 开发指南</a>
</span>
<!--span class="number">
11
</span-->
<ul>
<li><span class="title">
<a href="#4.1-设计功能与撰写描述文件" title="4.1 设计功能与撰写描述文件">4.1 设计功能与撰写描述文件</a>
</span>
<!--span class="number">
12
</span-->
</li>
<li><span class="title">
<a href="#4.2-利用工具代码加快开发进度" title="4.2 利用工具代码加快开发进度">4.2 利用工具代码加快开发进度</a>
</span>
<!--span class="number">
13
</span-->
<ul>
<li><span class="title">
<a href="#4.2.1-命令行解释" title="4.2.1 命令行解释">4.2.1 命令行解释</a>
</span>
<!--span class="number">
14
</span-->
</li>
<li><span class="title">
<a href="#4.2.2-数据收发" title="4.2.2 数据收发">4.2.2 数据收发</a>
</span>
<!--span class="number">
15
</span-->
</li>
<li><span class="title">
<a href="#4.2.3-调试" title="4.2.3 调试">4.2.3 调试</a>
</span>
<!--span class="number">
16
</span-->
<ul>
<li><span class="title">
<a href="#(1)录制" title="(1)录制">(1)录制</a>
</span>
<!--span class="number">
17
</span-->
</li>
<li><span class="title">
<a href="#(2)回放与调试" title="(2)回放与调试">(2)回放与调试</a>
</span>
<!--span class="number">
18
</span-->
</li>
</ul>
</li>
</ul>
</li>
<li><span class="title">
<a href="#4.3-数据处理" title="4.3 数据处理">4.3 数据处理</a>
</span>
<!--span class="number">
19
</span-->
<ul>
<li><span class="title">
<a href="#4.3.1-数据缓存建议" title="4.3.1 数据缓存建议">4.3.1 数据缓存建议</a>
</span>
<!--span class="number">
20
</span-->
</li>
<li><span class="title">
<a href="#4.3.2-负荷控制" title="4.3.2 负荷控制">4.3.2 负荷控制</a>
</span>
<!--span class="number">
21
</span-->
</li>
</ul>
</li>
<li><span class="title">
<a href="#4.4-运行与发布" title="4.4 运行与发布">4.4 运行与发布</a>
</span>
<!--span class="number">
22
</span-->
<ul>
<li><span class="title">
<a href="#4.4.1-路径策略" title="4.4.1 路径策略">4.4.1 路径策略</a>
</span>
<!--span class="number">
23
</span-->
</li>
<li><span class="title">
<a href="#4.4.2-子工程与嵌套" title="4.4.2 子工程与嵌套">4.4.2 子工程与嵌套</a>
</span>
<!--span class="number">
24
</span-->
<ul>
<li><span class="title">
<a href="#（1）-创建子工程" title="（1） 创建子工程">（1） 创建子工程</a>
</span>
<!--span class="number">
25
</span-->
</li>
<li><span class="title">
<a href="#（2）-附加包装器" title="（2） 附加包装器">（2） 附加包装器</a>
</span>
<!--span class="number">
26
</span-->
</li>
<li><span class="title">
<a href="#（3）-附加默认模块加载脚本" title="（3） 附加默认模块加载脚本">（3） 附加默认模块加载脚本</a>
</span>
<!--span class="number">
27
</span-->
</li>
<li><span class="title">
<a href="#（4）载入子项目模块" title="（4）载入子项目模块">（4）载入子项目模块</a>
</span>
<!--span class="number">
28
</span-->
</li>
</ul>
</li>
</ul>
</li>
<li><span class="title">
<a href="#4.5-多平台、分布式及扩展" title="4.5 多平台、分布式及扩展">4.5 多平台、分布式及扩展</a>
</span>
<!--span class="number">
29
</span-->
</li>
</ul>
</li>
<li><span class="title">
<a href="#5-关于taskbus" title="5 关于taskBus">5 关于taskBus</a>
</span>
<!--span class="number">
30
</span-->
</li>
</ul>
</li>

</ul>
<p></p><h2 id="1.-什么是taskbus"><a name="1.-什么是taskbus" href="#1.-什么是taskbus"></a>1. 什么是Taskbus</h2><p>Taskbus 是一种面向非专业开发者的跨平台多进程合作框架，具有进程切割、语言无关、编译器无关、架构无关四个特点。</p><p>非专业开发者是一个泛泛的概念，可以理解为没有受过专业化的软件工程化训练的开发者。诸如需要频繁自行开发小工具进行算法验证的高校教研团队，以及深入某一领域（化工、机械、通信、电子等）进行数据分析，需要长期从事非消费类工具软件开发的工程师团队。</p><p>Taskbus 从感官上提供一种类似Simulink或GNU-Radio的模块化拖拽界面，可用于在通用计算机上实现准实时的处理逻辑。但是，从结构上，其与二者完全不同。Taskbus 对编译器、运行平台、开发语言不做要求。它通过定义一种功能发布与数据交换标准，提供一套进程管理平台，以便把不同语言开发的进程组合起来。在例子中，您可以看到Python2/3，NodeJS，C#，GNUOctave、Qt、C++、MFC等等工具链生成的模块，它们在平台统一调度下完成功能。</p><p><img src="images/main_ui_zh_CN.jpg" alt="taskBus UI"></p><h2 id="2.-关键特性"><a name="2.-关键特性" href="#2.-关键特性"></a>2. 关键特性</h2><p>taskBus 的核心理念是 “定IO标准不定具体工具，定连接结构不定架构算法”</p><ol>
<li>taskBus 仅定义数据交换的方法与格式，对具体实现语言、运行环境没有要求。这带来了非常高的灵活性。</li><li>taskBus 仅定义进程间的逻辑连接结构，并不定义用户搭建的具体功能所采用的架构、所需要的方法。<br>它的关键特性：</li></ol><ul>
<li><strong>简单</strong>： 进程通过标准输入输出（stdin,stdout,stderr）吞吐数据、命令行参数接受初始化参数。没有对数据库、COM、CORBA、动态链接、SOAP或网络协议的知识要求。基于平台提供的调试功能，经过录制、回放操作，可以脱离平台独立调试各个模块的逻辑。</li><li><strong>灵活</strong>： 通过专题（Subject）、通路（Path），通过标准输入输出管道可以分时处理多个逻辑流。它们之间的关系完全由模块设计者确定。基于网络模块、数据库模块提供的功能，可以在不同的操作系统上构建分布式的处理系统。您甚至可以用封装器把Matlab、Octave、Python程序包装进来。</li><li><strong>稳定</strong>： 错误被控制在一个模块进程内部，易于发现问题。 可为各个模块设置独立的优先级（nice）。</li><li><strong>高效</strong>:  多进程并行、分布式计算与优先级控制，使得通用PC计算环境也可达到实时处理/准实时处理的能力。当您的模块加入GPU加速等特性后，可以使整个系统性能得到大幅度提升。</li><li><strong>推送而非请求</strong>：与GNU-Radio不同，taskBus的前序模块主动向后端推送数据，而负荷控制由模块通过简单的方法实现（参考下文“负荷控制”部分）。</li></ul><p><img src="images/features_zh_CN.png" alt="features_zh_CN UI"></p><h2 id="3.-基本原理"><a name="3.-基本原理" href="#3.-基本原理"></a>3. 基本原理</h2><p>很多经典的编程语言课本都是从控制台开始的. 控制台程序通过键盘接收用户输入，向屏幕打印运算结果。事实上，无论在Linux还是Windows中，进程启动时便有三个特殊的文件句柄可用了。他们是标准输出(stdout)，标准输入(stdin)，标准错误(stderr)。默认情况下，stdin与键盘关联，stdout、stderr与屏幕关联。</p><p>大多数现代语言支持创建子进程, 并且可以通过 “管道重定向” 技术接管子进程的标准管道。Taskbus 技术即基于此特性，从各个子进程的stdout读取数据，并转发给需要的子进程（stdin）。</p><h3 id="3.1-输入输出"><a name="3.1-输入输出" href="#3.1-输入输出"></a>3.1 输入输出</h3><p>一个实现XOR操作的教科书C程序，一般类似这样：</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>#include &amp;lt;stdio.h&amp;gt;
int main(int argc, char *argv[])
{
    unsigned int a[4];
    scanf(&quot;%u,%u,%u,%u&quot;,a,a+1,a+2,a+3);
    for(int i = 0; i &amp;lt; 4; ++i)
        a[i] = 0xFFFFFFFF ^ a[i];
    printf(&quot;%u,%u,%u,%u\n&quot;,a[0],a[1],a[2],a[3]);
    return 0;
}
</code></pre>"><span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> &lt;stdio.h&gt;</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> a[<span class="hljs-number">4</span>];
    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%u,%u,%u,%u"</span>,a,a+<span class="hljs-number">1</span>,a+<span class="hljs-number">2</span>,a+<span class="hljs-number">3</span>);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; ++i)
        a[i] = <span class="hljs-number">0xFFFFFFFF</span> ^ a[i];
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%u,%u,%u,%u\n"</span>,a[<span class="hljs-number">0</span>],a[<span class="hljs-number">1</span>],a[<span class="hljs-number">2</span>],a[<span class="hljs-number">3</span>]);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><p>上面的程序里，从键盘输入四个数字，取反后输出。由于键盘与stdin关联，屏幕与stdout关联，上述程序实质上与下面的程序等效：</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>    fscanf(stdin,&quot;%u,%u,%u,%u&quot;,a,a+1,a+2,a+3);
    fprintf(stdout,&quot;%u,%u,%u,%u\n&quot;,a[0],a[1],a[2],a[3]);
</code></pre>">    <span class="hljs-built_in">fscanf</span>(stdin,<span class="hljs-string">"%u,%u,%u,%u"</span>,a,a+<span class="hljs-number">1</span>,a+<span class="hljs-number">2</span>,a+<span class="hljs-number">3</span>);
    <span class="hljs-built_in">fprintf</span>(stdout,<span class="hljs-string">"%u,%u,%u,%u\n"</span>,a[<span class="hljs-number">0</span>],a[<span class="hljs-number">1</span>],a[<span class="hljs-number">2</span>],a[<span class="hljs-number">3</span>]);
</code></pre><p>Taskbus 模块的输入输出与上述程序非常类似，唯一的区别是使用了二进制读写函数:</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>    unsigned int a[4];
    fread(a,sizeof(int),4,stdin);
    for(int i = 0; i &amp;lt; 4; ++i)
        a[i] = 0xFFFFFFFF ^ a[i];
    fwrite(a,sizeof(int),4,stdout);
</code></pre>">    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> a[<span class="hljs-number">4</span>];
    fread(a,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">4</span>,stdin);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; ++i)
        a[i] = <span class="hljs-number">0xFFFFFFFF</span> ^ a[i];
    fwrite(a,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">4</span>,stdout);
</code></pre><h3 id="3.2-专题与通路"><a name="3.2-专题与通路" href="#3.2-专题与通路"></a>3.2 专题与通路</h3><p>一个子进程只有一对输入输出管道。通过设置专题与通路，可以仅用一路管道分享多路内容。</p><h4 id="3.2.1-专题"><a name="3.2.1-专题" href="#3.2.1-专题"></a>3.2.1 专题</h4><p>专题（Subject）指示一类数据。如声卡采集的波形，以及从文件中读取的字节流。<br>在图形界面上，专题显示为管脚。每个专题有一个便于记忆的名字；在运行时，taskBus平台会根据连线关系，为每个专题设置一个整数ID。ID相同的输入、输出管脚会被连接起来。</p><p><img src="images/Subjects.png" alt="Subjects UI"></p><p>一个专题的生产者生成数据，交给平台。平台把数据交给所有连接了此专题的消费者。</p><p><strong>注意：</strong> 不同的管脚可以生产同一ID的专题，也可以监听一个相同的专题。对生产者，这样做的行为是一致的。对消费者，如何处理专题ID相同的情况，取决于模块实现者。</p><h4 id="3.2.2-通路"><a name="3.2.2-通路" href="#3.2.2-通路"></a>3.2.2 通路</h4><p>通路(PATH)在一类专题中，区分一条独立的自然时序。下面的例子中，两路声卡采集的数据汇入同一个FFT变换器。对于变换器来说，需要区分出两条自然时序，才能不导致混淆。</p><p><img src="images/Paths.png" alt="Paths UI"></p><p>上图中的声卡模块采用自身的进程ID（2、6）作为通路号，这样非常便捷地标定了数据的来源。</p><h3 id="3.3-带有专题和通路的io"><a name="3.3-带有专题和通路的io" href="#3.3-带有专题和通路的io"></a>3.3 带有专题和通路的IO</h3><p>鉴于上面的介绍，我们在前文代码中稍加修改，即可实现基于stdio的通信。</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>void record( char a[], int data_len, int path_id)
{
    int out_subject_id, out_path_id;
    int out_data_len;
    char b[MAX_LEN];
    deal(a, datalen,path_id,
         &amp;amp;out_subject_id,
         &amp;amp;out_path_id,
         &amp;amp;out_data_len,
         b
         );
    fwrite (&amp;amp;out_subject_id,sizeof(int),1,stdin);
    fwrite (&amp;amp;out_path_id,sizeof(int),1,stdin);
    fwrite (&amp;amp;out_data_len,sizeof(int),1,stdin);
    fwrite (b,sizeof(char),out_data_len,stdin);
}
int main(int argc, char *argv[])
{
    int subject_id, path_id;
    int data_len;
    char a[MAX_LEN];
    while (!finished())
    {
        fread (&amp;amp;subject_id,sizeof(int),1,stdin);
        fread (&amp;amp;path_id,sizeof(int),1,stdin);
        fread (&amp;amp;data_len,sizeof(int),1,stdin);
        fread (a,sizeof(char),data_len,stdin);
        switch (subject_id)
        {
        case ID_WAV:
            record(a,data_len,path_id);
            break;
        case ID_DAT:
            deal(a,data_len,path_id);
            break;
        default:
            break;
        }
    }
    return 0;
}
</code></pre>"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">record</span><span class="hljs-params">( <span class="hljs-keyword">char</span> a[], <span class="hljs-keyword">int</span> data_len, <span class="hljs-keyword">int</span> path_id)</span>
</span>{
    <span class="hljs-keyword">int</span> out_subject_id, out_path_id;
    <span class="hljs-keyword">int</span> out_data_len;
    <span class="hljs-keyword">char</span> b[MAX_LEN];
    deal(a, datalen,path_id,
         &amp;out_subject_id,
         &amp;out_path_id,
         &amp;out_data_len,
         b
         );
    fwrite (&amp;out_subject_id,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdin);
    fwrite (&amp;out_path_id,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdin);
    fwrite (&amp;out_data_len,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdin);
    fwrite (b,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>),out_data_len,stdin);
}
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
    <span class="hljs-keyword">int</span> subject_id, path_id;
    <span class="hljs-keyword">int</span> data_len;
    <span class="hljs-keyword">char</span> a[MAX_LEN];
    <span class="hljs-keyword">while</span> (!finished())
    {
        fread (&amp;subject_id,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdin);
        fread (&amp;path_id,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdin);
        fread (&amp;data_len,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdin);
        fread (a,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>),data_len,stdin);
        <span class="hljs-keyword">switch</span> (subject_id)
        {
        <span class="hljs-keyword">case</span> ID_WAV:
            record(a,data_len,path_id);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> ID_DAT:
            deal(a,data_len,path_id);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><p>上述代码缺少上下文，但清晰的示意了taskBus最基本的通信原理。不同模块之间，正是通过这样的方法进行沟通的。</p><h3 id="3.4-模块功能发布"><a name="3.4-模块功能发布" href="#3.4-模块功能发布"></a>3.4 模块功能发布</h3><p>由开发者独立开发的模块，需要使用JSON文件发布自己的功能。这样，平台就知道模块支持的专题类型、参数选项。<br>一个典型的功能描述文件必须包括三部分，分别是：</p><ol>
<li>参数表</li><li>输入专题表</li><li>输出专题表<br>其他用户自定义部分依旧可以读入并显示在平台，但没有实际的意义。 平台提供的helloworld例子包含两个功能，一个是比特抑或，一个是顺序取反。JSON文件的结构如下：</li></ol><pre class="json hljs"><code class="json" data-origin="<pre><code class=&quot;json&quot;>{
    &quot;example_bitxor&quot;:{
        &quot;name&quot;:&quot;bitxor&quot;,
        &quot;parameters&quot;:{
             &quot;mask&quot;:{
                &quot;type&quot;:&quot;unsigned char&quot;,
                &quot;tooltip&quot;:&quot;bytemask&quot;,
                &quot;default&quot;:255,
                &quot;range&quot;:{
                    &quot;min&quot;:0,
                    &quot;max&quot;:255
                }
            }
        },
        &quot;input_subjects&quot;:
        {
            &quot;data_in&quot;:{
                &quot;type&quot;:&quot;byte&quot;,
                &quot;tooltip&quot;:&quot;input&quot;
            }
        },
        &quot;output_subjects&quot;:{
            &quot;data_out&quot;:{
                &quot;type&quot;:&quot;byte&quot;,
                &quot;tooltip&quot;:&quot;output&quot;
            }
        },
        &quot;info&quot;:{
            &quot;auther&quot;:&quot;kelly&quot;,
            &quot;version&quot;:[1,0,0],
            &quot;mail&quot;:&quot;kelly@163.com&quot;
        }
    },
    &quot;example_reverse&quot;:{
        &quot;name&quot;:&quot;reverse&quot;,
        &quot;parameters&quot;:{
         },
        &quot;input_subjects&quot;:
        {
            &quot;data_in&quot;:{
                &quot;type&quot;:&quot;byte&quot;,
                &quot;tooltip&quot;:&quot;input&quot;
            }
        },
        &quot;output_subjects&quot;:{
            &quot;data_out&quot;:{
                &quot;type&quot;:&quot;byte&quot;,
                &quot;tooltip&quot;:&quot;output&quot;
            }
        },
        &quot;info&quot;:{
            &quot;auther&quot;:&quot;kelly&quot;,
            &quot;version&quot;:[1,1,0],
            &quot;mail&quot;:&quot;kelly@163.com&quot;
        }
    }
}
</code></pre>">{
    "<span class="hljs-attribute">example_bitxor</span>":<span class="hljs-value">{
        "<span class="hljs-attribute">name</span>":<span class="hljs-value"><span class="hljs-string">"bitxor"</span></span>,
        "<span class="hljs-attribute">parameters</span>":<span class="hljs-value">{
             "<span class="hljs-attribute">mask</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"unsigned char"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"bytemask"</span></span>,
                "<span class="hljs-attribute">default</span>":<span class="hljs-value"><span class="hljs-number">255</span></span>,
                "<span class="hljs-attribute">range</span>":<span class="hljs-value">{
                    "<span class="hljs-attribute">min</span>":<span class="hljs-value"><span class="hljs-number">0</span></span>,
                    "<span class="hljs-attribute">max</span>":<span class="hljs-value"><span class="hljs-number">255</span>
                </span>}
            </span>}
        </span>}</span>,
        "<span class="hljs-attribute">input_subjects</span>":
        <span class="hljs-value">{
            "<span class="hljs-attribute">data_in</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"byte"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"input"</span>
            </span>}
        </span>}</span>,
        "<span class="hljs-attribute">output_subjects</span>":<span class="hljs-value">{
            "<span class="hljs-attribute">data_out</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"byte"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"output"</span>
            </span>}
        </span>}</span>,
        "<span class="hljs-attribute">info</span>":<span class="hljs-value">{
            "<span class="hljs-attribute">auther</span>":<span class="hljs-value"><span class="hljs-string">"kelly"</span></span>,
            "<span class="hljs-attribute">version</span>":<span class="hljs-value">[<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]</span>,
            "<span class="hljs-attribute">mail</span>":<span class="hljs-value"><span class="hljs-string">"kelly@163.com"</span>
        </span>}
    </span>}</span>,
    "<span class="hljs-attribute">example_reverse</span>":<span class="hljs-value">{
        "<span class="hljs-attribute">name</span>":<span class="hljs-value"><span class="hljs-string">"reverse"</span></span>,
        "<span class="hljs-attribute">parameters</span>":<span class="hljs-value">{
         }</span>,
        "<span class="hljs-attribute">input_subjects</span>":
        <span class="hljs-value">{
            "<span class="hljs-attribute">data_in</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"byte"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"input"</span>
            </span>}
        </span>}</span>,
        "<span class="hljs-attribute">output_subjects</span>":<span class="hljs-value">{
            "<span class="hljs-attribute">data_out</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"byte"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"output"</span>
            </span>}
        </span>}</span>,
        "<span class="hljs-attribute">info</span>":<span class="hljs-value">{
            "<span class="hljs-attribute">auther</span>":<span class="hljs-value"><span class="hljs-string">"kelly"</span></span>,
            "<span class="hljs-attribute">version</span>":<span class="hljs-value">[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>]</span>,
            "<span class="hljs-attribute">mail</span>":<span class="hljs-value"><span class="hljs-string">"kelly@163.com"</span>
        </span>}
    </span>}
</span>}
</code></pre><p>可以看到，文件由两大块组成。第一块为 example_bitxor部分，第二块为example_reverse，对应了两个功能。</p><p>在各个功能内部，又分name、parameters、input_subject、output_subject四个子项目，分别对应友好名称、静态属性、输入专题、输出专题。</p><p><strong>注意：</strong>尽管各个属性含有“type”类型指示以及range取值范围指示，但平台把所有输入输出看做字节流，这些取值仅仅为了提醒用户。一个成熟的模块应该有详细的接口文档描述输入输出类型、字节序、大小端。对文本类型，要明确或者可以设施字符集。上面的模块，在平台上显示为：</p><p><img src="images/example_module.png" alt="example_module UI"></p><h3 id="3.5-命令行参数"><a name="3.5-命令行参数" href="#3.5-命令行参数"></a>3.5 命令行参数</h3><p>taskBus 平台根据JSON文件启动进程。在启动各个功能模块时，taskBus 通过命令行参数送入所有的信息。命令行参数有如下几类。</p><table>
<thead>
<tr>
<th>类别</th>
<th>参数</th>
<th>意义</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>进程</td>
<td>——instance=&lt;M&gt;</td>
<td>向模块送入进程ID值</td>
<td>整形。用于区分独立的进程，这个措施避免了模块自己来生成唯一ID</td>
</tr>
<tr>
<td>进程</td>
<td>——function=&lt;N&gt;</td>
<td>向模块指定当前实例开启的功能。</td>
<td>一个模块可以支持很多功能。</td>
</tr>
<tr>
<td>进程</td>
<td>——information</td>
<td>平台请求模块输出JSON描述并退出。</td>
<td>模块既可以附带JSON文件，也可以在本参数中printf JSON。</td>
</tr>
<tr>
<td>专题</td>
<td>——&lt;sub_name&gt;=&lt;K&gt;</td>
<td>向模块指定专题名对应的ID</td>
<td>专题名由各个模块确定,可以出现多条。</td>
</tr>
<tr>
<td>用户属性</td>
<td>——&lt;Key&gt;=&lt;Value&gt;</td>
<td>用户自定的初始化属性</td>
<td>可在平台“属性”栏设置。</td>
</tr>
</tbody>
</table><p>以上述模块JSON为例子，下图中的模块，在启动时，命令行如下：</p><pre class="bash hljs"><code class="bash" data-origin="<pre><code class=&quot;bash&quot;>user@local$ example_helloworld.exe --instance=6 --function=example_bitxor --mask=255 --data_in=6 --data_out=1
</code></pre>">user@<span class="hljs-built_in">local</span>$ example_helloworld.exe --instance=<span class="hljs-number">6</span> --function=example_bitxor --mask=<span class="hljs-number">255</span> --data_<span class="hljs-keyword">in</span>=<span class="hljs-number">6</span> --data_out=<span class="hljs-number">1</span>
</code></pre><p><img src="images/commandline_zh_CN.png" alt="Paths UI"></p><h3 id="3.6-第一个hello-world-模块的代码"><a name="3.6-第一个hello-world-模块的代码" href="#3.6-第一个hello-world-模块的代码"></a>3.6 第一个Hello-world 模块的代码</h3><p>我们把HelloWold模块的代码粘贴到这里，使用C++，可以非常方便的实现上述功能。</p><ul>
<li>该代码没有使用任何标准C++之外的特性</li><li>事实上，在第四章您可以看到，我们已经为接入平台提前做好了不少简化工作。但简化工作会掩盖细节，下面的代码仍旧是最体现模块运行原理的好例子。</li></ul><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>#include &amp;lt;cstdio&amp;gt;
#include &amp;lt;string&amp;gt;
#include &amp;lt;cstring&amp;gt;
#include &amp;lt;cstdlib&amp;gt;
#ifdef WINNT
#include &amp;lt;io.h&amp;gt;
#include &amp;lt;fcntl.h&amp;gt;
#endif
using namespace std;
#define MAX_DTALEN 65536
int main(int argc, char * argv[])
{
    //In windows, stdio must be set to BINARY mode, to
    //prevent linebreak \\n\\r replace.
#ifdef WINNT
    setmode(fileno(stdout),O_BINARY);
    setmode(fileno(stdin),O_BINARY);
#endif
    bool bInfo = false, finished = false;
    int instance = 0;
    int sub_input = 0, sub_output = 0;
    char mask = 0;
    string function;
    //1. parse cmdline
    for (int i=1;i&amp;lt;argc;++i)
    {
        string arg_key = argv[i], arg_value = argv[i];
        int idx = arg_key.find('=');
        if (idx&amp;gt;=0 &amp;amp;&amp;amp; idx&amp;lt;arg_key.size())
        {
            arg_key = arg_key.substr(0,idx);
            arg_value = arg_value.substr(idx+1);
        }
        if (arg_key==&quot;--function&quot;)
            function = arg_value;
        else if (arg_key==&quot;--information&quot;)
            bInfo = true;
        else if (arg_key==&quot;--instance&quot;)
            instance = atoi(arg_value.c_str());
        else if (arg_key==&quot;--data_in&quot;)
            sub_input = atoi(arg_value.c_str());
        else if (arg_key==&quot;--data_out&quot;)
            sub_output = atoi(arg_value.c_str());
        else if (arg_key==&quot;--mask&quot;)
            mask = atoi(arg_value.c_str());
        fprintf(stderr,&quot;%s:%s\n&quot;,arg_key.c_str(),arg_value.c_str());
        fflush(stderr);
    }
    //2. function case
    if (bInfo)
    {
        //In this example, json file will be published with exe file.
        //We will return directly.  Or, you can output json here to stdout,
        //If you do not want to publish your json file.
        return 0;
    }
    else if (instance&amp;lt;=0 || function.length()==0)
        return -1;
    else
    {
        char header[4], data[MAX_DTALEN+1];
        memset(data,0,MAX_DTALEN+1);
        int n_sub = 0, n_path = 0, n_len = 0;
        while(false==finished)
        {
            fread(header,1,4,stdin);    //2.1 read header
            if (header[0]!=0x3C || header[1]!=0x5A || header[2]!=0x7E || header[3]!=0x69)
            {
                fprintf(stderr,&quot;Bad header\n&quot;);
                break;
            }
            fread(&amp;amp;n_sub,sizeof(int),1,stdin);
            fread(&amp;amp;n_path,sizeof(int),1,stdin);
            fread(&amp;amp;n_len,sizeof(int),1,stdin);
            if (n_len&amp;lt;0 || n_len &amp;gt;MAX_DTALEN)
            {
                fprintf(stderr,&quot;Bad length %d\n&quot;,n_len);
                break;
            }
            fread(data,sizeof(char),n_len,stdin);

            if (n_sub&amp;lt;=0)
            {
                if (strstr(data, &quot;quit&quot;)!=nullptr)
                {
                    finished = true;
                    continue;
                }
            }
            else if (n_sub != sub_input)
                continue;

            if (function==&quot;example_bitxor&quot;)
            {
                for (int i=0;i&amp;lt;n_len;++i)
                    data[i] ^= mask;
            }
            else if (function==&quot;example_reverse&quot;)
            {
                for (int i=0;i&amp;lt;n_len/2;++i)
                {
                    char t = data[i];
                    data[i] = data[n_len-1-i];
                    data[n_len-1-i] = t;
                }
            }
            else
            {
                fprintf(stderr,&quot;Unknown function %s\n&quot;,function.c_str());
                break;
            }
            fwrite(header,1,4,stdout);
            fwrite(&amp;amp;sub_output,sizeof(int),1,stdout);
            fwrite(&amp;amp;n_path,sizeof(int),1,stdout);
            fwrite(&amp;amp;n_len,sizeof(int),1,stdout);
            fwrite(data,sizeof(char),n_len,stdout);
            fflush(stdout);
        }
    }
    //3.exit
    return 0;
}
</code></pre>"><span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> &lt;cstdio&gt;</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> &lt;string&gt;</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> &lt;cstring&gt;</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> &lt;cstdlib&gt;</span>
<span class="hljs-preprocessor">#ifdef WINNT</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> &lt;io.h&gt;</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> &lt;fcntl.h&gt;</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">endif</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> MAX_DTALEN 65536</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> * argv[])</span>
</span>{
    <span class="hljs-comment">//In windows, stdio must be set to BINARY mode, to</span>
    <span class="hljs-comment">//prevent linebreak \\n\\r replace.</span>
<span class="hljs-preprocessor">#ifdef WINNT</span>
    setmode(fileno(stdout),O_BINARY);
    setmode(fileno(stdin),O_BINARY);
<span class="hljs-preprocessor">#<span class="hljs-keyword">endif</span></span>
    <span class="hljs-keyword">bool</span> bInfo = <span class="hljs-keyword">false</span>, finished = <span class="hljs-keyword">false</span>;
    <span class="hljs-keyword">int</span> instance = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> sub_input = <span class="hljs-number">0</span>, sub_output = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">char</span> mask = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">string</span> function;
    <span class="hljs-comment">//1. parse cmdline</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;argc;++i)
    {
        <span class="hljs-built_in">string</span> arg_key = argv[i], arg_value = argv[i];
        <span class="hljs-keyword">int</span> idx = arg_key.find(<span class="hljs-string">'='</span>);
        <span class="hljs-keyword">if</span> (idx&gt;=<span class="hljs-number">0</span> &amp;&amp; idx&lt;arg_key.size())
        {
            arg_key = arg_key.substr(<span class="hljs-number">0</span>,idx);
            arg_value = arg_value.substr(idx+<span class="hljs-number">1</span>);
        }
        <span class="hljs-keyword">if</span> (arg_key==<span class="hljs-string">"--function"</span>)
            function = arg_value;
        <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(arg_key=="--information")</span>
            bInfo </span>= <span class="hljs-keyword">true</span>;
        <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(arg_key=="--instance")</span>
            instance </span>= atoi(arg_value.c_str());
        <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(arg_key=="--data_in")</span>
            sub_input </span>= atoi(arg_value.c_str());
        <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(arg_key=="--data_out")</span>
            sub_output </span>= atoi(arg_value.c_str());
        <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(arg_key=="--mask")</span>
            mask </span>= atoi(arg_value.c_str());
        <span class="hljs-built_in">fprintf</span>(stderr,<span class="hljs-string">"%s:%s\n"</span>,arg_key.c_str(),arg_value.c_str());
        fflush(stderr);
    }
    <span class="hljs-comment">//2. function case</span>
    <span class="hljs-keyword">if</span> (bInfo)
    {
        <span class="hljs-comment">//In this example, json file will be published with exe file.</span>
        <span class="hljs-comment">//We will return directly.  Or, you can output json here to stdout,</span>
        <span class="hljs-comment">//If you do not want to publish your json file.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(instance&lt;=0 || function.length()</span></span>==<span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-keyword">char</span> header[<span class="hljs-number">4</span>], data[MAX_DTALEN+<span class="hljs-number">1</span>];
        <span class="hljs-built_in">memset</span>(data,<span class="hljs-number">0</span>,MAX_DTALEN+<span class="hljs-number">1</span>);
        <span class="hljs-keyword">int</span> n_sub = <span class="hljs-number">0</span>, n_path = <span class="hljs-number">0</span>, n_len = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span>(<span class="hljs-keyword">false</span>==finished)
        {
            fread(header,<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,stdin);    <span class="hljs-comment">//2.1 read header</span>
            <span class="hljs-keyword">if</span> (header[<span class="hljs-number">0</span>]!=<span class="hljs-number">0x3C</span> || header[<span class="hljs-number">1</span>]!=<span class="hljs-number">0x5A</span> || header[<span class="hljs-number">2</span>]!=<span class="hljs-number">0x7E</span> || header[<span class="hljs-number">3</span>]!=<span class="hljs-number">0x69</span>)
            {
                <span class="hljs-built_in">fprintf</span>(stderr,<span class="hljs-string">"Bad header\n"</span>);
                <span class="hljs-keyword">break</span>;
            }
            fread(&amp;n_sub,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdin);
            fread(&amp;n_path,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdin);
            fread(&amp;n_len,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdin);
            <span class="hljs-keyword">if</span> (n_len&lt;<span class="hljs-number">0</span> || n_len &gt;MAX_DTALEN)
            {
                <span class="hljs-built_in">fprintf</span>(stderr,<span class="hljs-string">"Bad length %d\n"</span>,n_len);
                <span class="hljs-keyword">break</span>;
            }
            fread(data,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>),n_len,stdin);

            <span class="hljs-keyword">if</span> (n_sub&lt;=<span class="hljs-number">0</span>)
            {
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(data, <span class="hljs-string">"quit"</span>)!=<span class="hljs-keyword">nullptr</span>)
                {
                    finished = <span class="hljs-keyword">true</span>;
                    <span class="hljs-keyword">continue</span>;
                }
            }
            <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(n_sub != sub_input)</span>
                <span class="hljs-keyword">continue</span></span>;

            <span class="hljs-keyword">if</span> (function==<span class="hljs-string">"example_bitxor"</span>)
            {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;n_len;++i)
                    data[i] ^= mask;
            }
            <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(function=="example_reverse")</span>
            </span>{
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;n_len/<span class="hljs-number">2</span>;++i)
                {
                    <span class="hljs-keyword">char</span> t = data[i];
                    data[i] = data[n_len-<span class="hljs-number">1</span>-i];
                    data[n_len-<span class="hljs-number">1</span>-i] = t;
                }
            }
            <span class="hljs-keyword">else</span>
            {
                <span class="hljs-built_in">fprintf</span>(stderr,<span class="hljs-string">"Unknown function %s\n"</span>,function.c_str());
                <span class="hljs-keyword">break</span>;
            }
            fwrite(header,<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,stdout);
            fwrite(&amp;sub_output,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdout);
            fwrite(&amp;n_path,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdout);
            fwrite(&amp;n_len,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>),<span class="hljs-number">1</span>,stdout);
            fwrite(data,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>),n_len,stdout);
            fflush(stdout);
        }
    }
    <span class="hljs-comment">//3.exit</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><h2 id="4.-开发指南"><a name="4.-开发指南" href="#4.-开发指南"></a>4. 开发指南</h2><p>我们将以fftw为例子，介绍如何从0开始创建一个taskBus模块。</p><h3 id="4.1-设计功能与撰写描述文件"><a name="4.1-设计功能与撰写描述文件" href="#4.1-设计功能与撰写描述文件"></a>4.1 设计功能与撰写描述文件</h3><p>创建一个模块的第一步，是设计功能，并确定接口、属性，撰写JSON文件。撰写JSON文件最快的方法是从例子修改，并保存为与可执行文件同名的json文件。使用UTF-8编码书写亚洲字符有利于加载速度。只要有JSON文件，即使模块没有完全实现，也可以在平台上看到效果。我们要设计的FFT模块，应该具备以下的结构：</p><p><img src="images/fftw.png" alt="FFTW"></p><p>它具备时戳、信号两个输入接口（Subject）；具备时戳、复数形式、幅度谱三个输出接口（Subject）。此外，可以支持用户配置FFT的点数、输入信号的波段数、样点数据类型三个静态参数。这些静态参数在用户单击图标时，可以在“属性”一栏修改，类似下图：</p><p><img src="images/fftw_para.png" alt="fftw_para"></p><p>具备上述特性的功能描述文件如下：</p><pre class="json hljs"><code class="json" data-origin="<pre><code class=&quot;json&quot;>{
    &quot;transform_fft&quot;:{
        &quot;name&quot;:&quot;libfftw&quot;,
        &quot;parameters&quot;:{
             &quot;sptype&quot;:{
                &quot;type&quot;:&quot;enum&quot;,
                &quot;tooltip&quot;:&quot;sample point format&quot;,
                &quot;default&quot;:0,
                &quot;range&quot;:{
                    &quot;0&quot;:&quot;16 bit Intel&quot;,
                    &quot;1&quot;:&quot;16 bit Moto&quot;,
                    &quot;2&quot;:&quot;int8&quot;,
                    &quot;3&quot;:&quot;uint8&quot;
                }
            },
             &quot;channels&quot;:{
                &quot;type&quot;:&quot;int&quot;,
                &quot;tooltip&quot;:&quot;Channels&quot;,
                &quot;default&quot;:1
            },            
            &quot;fftsize&quot;:{
                &quot;type&quot;:&quot;int&quot;,
                &quot;tooltip&quot;:&quot;fft size&quot;,
                &quot;default&quot;:1024
            }

        },
        &quot;input_subjects&quot;:
        {
            &quot;signal&quot;:{
                &quot;type&quot;:&quot;byte&quot;,
                &quot;tooltip&quot;:&quot;signal&quot;
            },
            &quot;tmstamp_in&quot;:{
                &quot;type&quot;:&quot;unsigned long long&quot;,
                &quot;tooltip&quot;:&quot;tmstamp_in&quot;
            }
        },
        &quot;output_subjects&quot;:{           
            &quot;FFT&quot;:{
                &quot;type&quot;:&quot;vector&quot;,
                &quot;tooltip&quot;:&quot;FFT in dB&quot;
            },
            &quot;Spec&quot;:{
                &quot;type&quot;:&quot;vector&quot;,
                &quot;tooltip&quot;:&quot;Spec in Complex&quot;
            },
            &quot;tmstamp_out&quot;:{
                &quot;type&quot;:&quot;unsigned long long&quot;,
                &quot;tooltip&quot;:&quot;tmstamp_out&quot;
            }

        }
    }
}
</code></pre>">{
    "<span class="hljs-attribute">transform_fft</span>":<span class="hljs-value">{
        "<span class="hljs-attribute">name</span>":<span class="hljs-value"><span class="hljs-string">"libfftw"</span></span>,
        "<span class="hljs-attribute">parameters</span>":<span class="hljs-value">{
             "<span class="hljs-attribute">sptype</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"enum"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"sample point format"</span></span>,
                "<span class="hljs-attribute">default</span>":<span class="hljs-value"><span class="hljs-number">0</span></span>,
                "<span class="hljs-attribute">range</span>":<span class="hljs-value">{
                    "<span class="hljs-attribute">0</span>":<span class="hljs-value"><span class="hljs-string">"16 bit Intel"</span></span>,
                    "<span class="hljs-attribute">1</span>":<span class="hljs-value"><span class="hljs-string">"16 bit Moto"</span></span>,
                    "<span class="hljs-attribute">2</span>":<span class="hljs-value"><span class="hljs-string">"int8"</span></span>,
                    "<span class="hljs-attribute">3</span>":<span class="hljs-value"><span class="hljs-string">"uint8"</span>
                </span>}
            </span>}</span>,
             "<span class="hljs-attribute">channels</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"int"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"Channels"</span></span>,
                "<span class="hljs-attribute">default</span>":<span class="hljs-value"><span class="hljs-number">1</span>
            </span>}</span>,            
            "<span class="hljs-attribute">fftsize</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"int"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"fft size"</span></span>,
                "<span class="hljs-attribute">default</span>":<span class="hljs-value"><span class="hljs-number">1024</span>
            </span>}

        </span>}</span>,
        "<span class="hljs-attribute">input_subjects</span>":
        <span class="hljs-value">{
            "<span class="hljs-attribute">signal</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"byte"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"signal"</span>
            </span>}</span>,
            "<span class="hljs-attribute">tmstamp_in</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"unsigned long long"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"tmstamp_in"</span>
            </span>}
        </span>}</span>,
        "<span class="hljs-attribute">output_subjects</span>":<span class="hljs-value">{           
            "<span class="hljs-attribute">FFT</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"vector"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"FFT in dB"</span>
            </span>}</span>,
            "<span class="hljs-attribute">Spec</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"vector"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"Spec in Complex"</span>
            </span>}</span>,
            "<span class="hljs-attribute">tmstamp_out</span>":<span class="hljs-value">{
                "<span class="hljs-attribute">type</span>":<span class="hljs-value"><span class="hljs-string">"unsigned long long"</span></span>,
                "<span class="hljs-attribute">tooltip</span>":<span class="hljs-value"><span class="hljs-string">"tmstamp_out"</span>
            </span>}

        </span>}
    </span>}
</span>}
</code></pre><p>一旦具备了上述JSON文件，只要搭配一个空白的可执行文件（文件名相同，扩展名不同），即可在平台载入并编辑——当然无法运行。</p><h3 id="4.2-利用工具代码加快开发进度"><a name="4.2-利用工具代码加快开发进度" href="#4.2-利用工具代码加快开发进度"></a>4.2 利用工具代码加快开发进度</h3><p>如果您使用C#等特性丰富的语言，对命令行解析等操作会比较方便。对C++，平台提供了可直接加速开发速度的源代码，使用这些源码，会显著提高开发效率，简化代码量。</p><h4 id="4.2.1-命令行解释"><a name="4.2.1-命令行解释" href="#4.2.1-命令行解释"></a>4.2.1 命令行解释</h4><p>实现模块功能的第一步，是获取命令行参数。您可以采用Helloworld的代码实现命令行解析，但那样做显得比较复杂。使用提供的类，命令行解析、提取变得非常简单。无论是Qt、C++还是MFC，均可以采取类似的措施。</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>#include &quot;cmdlineparser.h&quot;
#include &quot;tb_interface.h&quot;
using namespace TASKBUS;
int main(int argc , char * argv[])
{
    init_client();
    cmdlineParser args(argc,argv);
    if (args.contains(&quot;information&quot;))
        putjson();
    else if (args.contains(&quot;function&quot;,&quot;tranform_fft&quot;))
    {
        const int instance        = args.toInt(&quot;instance&quot;,0);
        const int isource        = args.toInt(&quot;signal&quot;,0);
        const int FFT              = args.toInt(&quot;FFT&quot;,0);
        const int Spec             = args.toInt(&quot;Spec&quot;,0);
        const int itmstamp_in  = args.toInt(&quot;tmstamp_in&quot;,0);
        const int itmstamp_out = args.toInt(&quot;tmstamp_out&quot;,0);
        const int sptype    =    args.toInt(&quot;sptype&quot;,0);
        const int channels    =    args.toInt(&quot;channels&quot;,1);
        const int fftsize    =  args.toInt(&quot;fftsize&quot;,1024);
        //...work
    }
    else
        fprintf(stderr,&quot;Error:Function does not exits.&quot;);
    return 0;
}
</code></pre>"><span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> "cmdlineparser.h"</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> "tb_interface.h"</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> TASKBUS;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc , <span class="hljs-keyword">char</span> * argv[])</span>
</span>{
    init_client();
    <span class="hljs-function">cmdlineParser <span class="hljs-title">args</span><span class="hljs-params">(argc,argv)</span></span>;
    <span class="hljs-keyword">if</span> (args.contains(<span class="hljs-string">"information"</span>))
        putjson();
    <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(args.contains("function","tranform_fft")</span>)
    </span>{
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> instance        = args.toInt(<span class="hljs-string">"instance"</span>,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> isource        = args.toInt(<span class="hljs-string">"signal"</span>,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> FFT              = args.toInt(<span class="hljs-string">"FFT"</span>,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Spec             = args.toInt(<span class="hljs-string">"Spec"</span>,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> itmstamp_in  = args.toInt(<span class="hljs-string">"tmstamp_in"</span>,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> itmstamp_out = args.toInt(<span class="hljs-string">"tmstamp_out"</span>,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> sptype    =    args.toInt(<span class="hljs-string">"sptype"</span>,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> channels    =    args.toInt(<span class="hljs-string">"channels"</span>,<span class="hljs-number">1</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> fftsize    =  args.toInt(<span class="hljs-string">"fftsize"</span>,<span class="hljs-number">1024</span>);
        <span class="hljs-comment">//...work</span>
    }
    <span class="hljs-function"><span class="hljs-keyword">else</span>
        <span class="hljs-title">fprintf</span><span class="hljs-params">(stderr,"Error:Function does not exits.")</span></span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><p>对Qt、MFC、C#的例子，可以参考范例代码。</p><h4 id="4.2.2-数据收发"><a name="4.2.2-数据收发" href="#4.2.2-数据收发"></a>4.2.2 数据收发</h4><p>taskBus的数据吞吐格式是固定的。其严格遵循下面的顺序：</p><table>
<thead>
<tr>
<th>package</th>
<th>record</th>
<th>type</th>
<th>length(bytes)</th>
<th>meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>header</td>
<td>unsigned char [4]</td>
<td>4</td>
<td>必须为0x3C,0x5A,0x7E,0x69，以便用WinHex等软件调试</td>
</tr>
<tr>
<td>1</td>
<td>subject_id</td>
<td>int</td>
<td>4</td>
<td>0: Control commands, &gt;0:user subjects, &lt;0 reserved</td>
</tr>
<tr>
<td>1</td>
<td>path_id</td>
<td>int</td>
<td>4</td>
<td>&gt;=0:user subjects, &lt;0 reserved</td>
</tr>
<tr>
<td>1</td>
<td>data_len</td>
<td>int</td>
<td>4</td>
<td>&gt;0, following data length in bytes</td>
</tr>
<tr>
<td>1</td>
<td>data</td>
<td>unsigned char</td>
<td>data_len</td>
<td>&gt;0, data in bytes</td>
</tr>
<tr>
<td>2</td>
<td>header</td>
<td>unsigned char [4]</td>
<td>4</td>
<td>0x3C,0x5A,0x7E,0x69</td>
</tr>
<tr>
<td>2</td>
<td>subject_id</td>
<td>int</td>
<td>4</td>
<td>0: Control commands, &gt;0:user subjects, &lt;0 reserved</td>
</tr>
<tr>
<td>2</td>
<td>path_id</td>
<td>int</td>
<td>4</td>
<td>&gt;=0:user subjects, &lt;0 reserved</td>
</tr>
<tr>
<td>2</td>
<td>data_len</td>
<td>int</td>
<td>4</td>
<td>&gt;0, following data length in bytes</td>
</tr>
<tr>
<td>2</td>
<td>data</td>
<td>unsigned char</td>
<td>data_len</td>
<td>&gt;0, data in bytes</td>
</tr>
<tr>
<td>3…</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table><p>使用工具代码，可以直接完成数据收发。主要推送函数有：</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>    void push_subject(
        const unsigned int subject_id,
        const unsigned int path_id,
        const unsigned int data_length,
        const unsigned char   *dataptr
        );
    void push_subject(
        const unsigned int subject_id,
        const unsigned int path_id,
        const char   *dataptr
        );
    void push_subject(
        const unsigned char   *allptr,
        const unsigned int totalLength
        );
    void push_subject(
        const subject_package_header header,
        const unsigned char   *dataptr
        );
</code></pre>">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">push_subject</span><span class="hljs-params">(
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> subject_id,
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> path_id,
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> data_length,
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>   *dataptr
        )</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">push_subject</span><span class="hljs-params">(
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> subject_id,
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> path_id,
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>   *dataptr
        )</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">push_subject</span><span class="hljs-params">(
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>   *allptr,
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> totalLength
        )</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">push_subject</span><span class="hljs-params">(
        <span class="hljs-keyword">const</span> subject_package_header header,
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>   *dataptr
        )</span></span>;
</code></pre><p>接收函数（阻塞）为：</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>   std::vector&amp;lt;unsigned char&amp;gt; pull_subject(  subject_package_header * header  );
</code></pre>">   <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>&gt; pull_subject(  subject_package_header * header  );
</code></pre><p><strong>性能说明：</strong>该函数会直接返回一个向量，含有一个完整数据包（不包括头部）的数据内容。由于默认使用C++14以上标准，返回 std::vector&lt;unsigned char&gt; 并不会导致内存深度拷贝，而是触发右值引用与内存传递。</p><p>使用上述工具函数的收发代码片段如下：</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>        while (false==bfinished)
        {
            subject_package_header header;
            vector&amp;lt;unsigned char&amp;gt; packagedta = pull_subject(&amp;amp;header);
            if (is_valid_header(header)==false)
                break;
            if ( is_control_subject(header))
            {                
                if (strstr(control_subject(header,packagedta).c_str(),&quot;\&quot;quit\&quot;:&quot;)!=nullptr)
                    bfinished = true;
            }
            else if (header.subject_id==source)
            {
                //...fft
                //output
                if (FFT&amp;gt;0)
                    push_subject(FFT,header.path_id,fftsize*sizeof(double),(const unsigned char *)vec_fft_abs.data());
                if (Spec&amp;gt;0)
                    push_subject(Spec,header.path_id,fftsize*sizeof(double),(const unsigned char *)out);
            }
        }
</code></pre>">        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">false</span>==bfinished)
        {
            subject_package_header header;
            <span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>&gt; packagedta = pull_subject(&amp;header);
            <span class="hljs-keyword">if</span> (is_valid_header(header)==<span class="hljs-keyword">false</span>)
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">if</span> ( is_control_subject(header))
            {                
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(control_subject(header,packagedta).c_str(),<span class="hljs-string">"\"quit\":"</span>)!=<span class="hljs-keyword">nullptr</span>)
                    bfinished = <span class="hljs-keyword">true</span>;
            }
            <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(header.subject_id==source)</span>
            </span>{
                <span class="hljs-comment">//...fft</span>
                <span class="hljs-comment">//output</span>
                <span class="hljs-keyword">if</span> (FFT&gt;<span class="hljs-number">0</span>)
                    push_subject(FFT,header.path_id,fftsize*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">double</span>),(<span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)vec_fft_abs.data());
                <span class="hljs-keyword">if</span> (Spec&gt;<span class="hljs-number">0</span>)
                    push_subject(Spec,header.path_id,fftsize*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">double</span>),(<span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)out);
            }
        }
</code></pre><h4 id="4.2.3-调试"><a name="4.2.3-调试" href="#4.2.3-调试"></a>4.2.3 调试</h4><p>为了一个简单的模块，从平台进程开始跟踪调试，需要在不同的语言、编译器开发的二进制机器代码中漫游，非常繁琐。幸运的是，taskBus提供了一套非常巧妙而简单的离线调试解决方案，使得您可以单独调试模块本身，并随时接入平台运行。</p><p>调试的核心思路是标准输入输出管道的重载。平台可以根据需要，把某个模块的输入输出数据、命令行启动参数等要素全部录制到磁盘上。而后，在调试平台时，只要指定录制文件夹，即可实现场景回放。</p><h5 id="(1)录制"><a name="(1)录制" href="#(1)录制"></a>(1)录制</h5><p>在主界面选中模块，单击“启动调试”按钮，会开启录制。</p><p><img src="images/turnon_debug.png" alt="turnon_debug"></p><p>一旦整个项目开始运行，记录数据会源源不断地记录在 debug 文件夹。子文件夹的名字为当前的操作系统进程ID，文件夹下有3个文件，分别对应stdin,stdout,stderr。注意，为了捕获所有异常，平台会一直独占日志，直到下一次调试开始运行。因此，为了结束录制，需要关闭平台或者再次启动工程。</p><p><img src="images/debug_folder.png" alt="turnon_debug"></p><h5 id="(2)回放与调试"><a name="(2)回放与调试" href="#(2)回放与调试"></a>(2)回放与调试</h5><p>回放与调试的关键技术是freopen的使用。这个特性能够在保持文件句柄不变的情况下，把实际来源重定向到文件。用户可以自己通过语句来实现，一旦下面这个语句被执行，数据吞吐的stdin将自动使用文件中录制的数据：</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>    std::string fm_stdin = strpath + &quot;/stdin.dat&quot;;
    freopen(fm_stdin.c_str(),&quot;rb&quot;,stdin);
</code></pre>">    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> fm_stdin = strpath + <span class="hljs-string">"/stdin.dat"</span>;
    freopen(fm_stdin.c_str(),<span class="hljs-string">"rb"</span>,stdin);
</code></pre><p>对于cpp，平台已经准备好了方便的工具函数。一个支持切换调试模式、正常模式的代码只需要在main入口添加几行代码：</p><pre class="cpp hljs"><code class="cpp" data-origin="<pre><code class=&quot;cpp&quot;>using namespace TASKBUS;
const int OFFLINEDEBUG = 0;
int main(int argc , char * argv[])
{
    init_client();
    cmdlineParser args;
    if (OFFLINEDEBUG==0)
        args.parser(argc,argv);
    else
    {
        auto ars = debug(&quot;debug/pid21580&quot;);
        args.parser(ars);
    }
    //...
}
</code></pre>"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> TASKBUS;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> OFFLINEDEBUG = <span class="hljs-number">0</span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc , <span class="hljs-keyword">char</span> * argv[])</span>
</span>{
    init_client();
    cmdlineParser args;
    <span class="hljs-keyword">if</span> (OFFLINEDEBUG==<span class="hljs-number">0</span>)
        args.parser(argc,argv);
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-keyword">auto</span> ars = debug(<span class="hljs-string">"debug/pid21580"</span>);
        args.parser(ars);
    }
    <span class="hljs-comment">//...</span>
}
</code></pre><p>在上面的代码中，将从debug/pid21580 读取先前录制的命令行参数、输入数据。这样，您就可以独立调试了。别忘了完成调试后，把调试开关OFFLINEDEBUG掷为0.</p><h3 id="4.3-数据处理"><a name="4.3-数据处理" href="#4.3-数据处理"></a>4.3 数据处理</h3><p>在前文的例子里，数据的处理都是没有记忆的。对到来的数据，直接处理后输出，是最简单的情况。然而，很多场景下我们需要应对数据记忆与多路处理问题。对于一个数据流量很大或者处理耗时的操作，负荷控制也是要考虑的问题。-</p><h4 id="4.3.1-数据缓存建议"><a name="4.3.1-数据缓存建议" href="#4.3.1-数据缓存建议"></a>4.3.1 数据缓存建议</h4><p>推荐使用STL库。</p><ul>
<li>若需要缓存旧的数据，使用STL容器是非常合适的选择。</li><li>对于不同的通路（path_id），缓存应该是独立的。此时，std::map&lt;path_id, cache&gt; 会提供非常好的操作性。</li><li>使用嵌套 map, vector, list，能够实现非常复杂的动态数据结构。</li><li>使用智能指针“shared_ptr”，也是一个好的主意。</li></ul><h4 id="4.3.2-负荷控制"><a name="4.3.2-负荷控制" href="#4.3.2-负荷控制"></a>4.3.2 负荷控制</h4><p>与Gnuradio的拉取方式不同，taskBus的生产者会主动推送数据。计算资源充裕时，设计者不需要考虑负荷控制的问题。但是在进行耗时的处理时，若没有措施保护，瓶颈模块可能会导致整个平台的内存开销不断增加。生产者不断写入stdout, 平台输出到消费者的stdin，看似没有问题。实际上，在windows下，平台写入的是操作系统的缓存。消费者若无法及时消费缓存，缓存会持续增长。</p><p>出于灵活性考虑，taskBus把这个问题留给模块设计者。模块设计者可以通过至少两种简单的策略解决这个问题。</p><ul>
<li>方法1，通过设置信号源的速率，确保信号以小于处理极限的速率生成。</li><li>方法2，消费者输出数据时戳，并向生产者回连，形成闭环。生产者检测回连时戳。若显著低于当前生产进度，则生产者调慢生产进度。</li></ul><p>下面这个范例工程即采用了策略2. 技术细节参考范例工程 source_soundcard.</p><p><img src="images/antiblocking.png" alt="antiblocking"></p><h3 id="4.4-运行与发布"><a name="4.4-运行与发布" href="#4.4-运行与发布"></a>4.4 运行与发布</h3><p>taskBus的运行时为绿色发布（copy-deployment）提供了遍历，开发者可参考下面的章节调整路径设置。</p><h4 id="4.4.1-路径策略"><a name="4.4.1-路径策略" href="#4.4.1-路径策略"></a>4.4.1 路径策略</h4><p>taskBus 的项目在启动时，会强制把当前路径设置到 taskBusPlatform 可执行文件所在的路径。taskBusPlatform 会读取同一文件夹下的 default_mods.text 预先加载所有的已知模块。这个文件中，每一行存储一个模块的可执行文件位置，一个范例如下所示：</p><pre><code class="text" data-origin="<pre><code class=&quot;text&quot;>../../../examples/voice_spec.exe
modules/network_p2p.exe
modules/sink_file.exe
modules/example_helloworld.exe
modules/source_files.exe
modules/transform_fft.exe
modules/sink_SQL.exe
modules/source_soundcard.exe
modules/sink_plots.exe
</code></pre>">../../../examples/voice_spec.exe
modules/network_p2p.exe
modules/sink_file.exe
modules/example_helloworld.exe
modules/source_files.exe
modules/transform_fft.exe
modules/sink_SQL.exe
modules/source_soundcard.exe
modules/sink_plots.exe
</code></pre><p>taskBusPlatform 会尽量使用相对路径存储模块的位置，除非绝对路径的字符长度要小于相对路径。因此，对于一个需要发布的系统，可以把所有模块放在 taskBusPlatform 可执行文件所在的路径中，用文件夹 modules 或 subs 等子文件夹管理。如此操作后，拷贝到新的计算机上，无需设置即可运行啦。</p><h4 id="4.4.2-子工程与嵌套"><a name="4.4.2-子工程与嵌套" href="#4.4.2-子工程与嵌套"></a>4.4.2 子工程与嵌套</h4><p>taskBus允许工程作为整体，被其他工程引用。所有悬空的引脚都会被分配临时ID，并暴露出来供外部工程链接。 以声卡的FFT为例，我们可以把声卡、FFT合成为一个“声音频谱”模块。</p><h5 id="（1）-创建子工程"><a name="（1）-创建子工程" href="#（1）-创建子工程"></a>（1） 创建子工程</h5><p>新建一个子工程，其结构如下：</p><p><img src="images/new_subprj.png" alt="new_subprj"></p><ul>
<li>这个子项目包括两个模块，声卡模块与fft模块。</li><li>fft模块的输出管脚悬空，作为子项目的外部接口。</li><li>如果有两个相同名称的悬空接口，会使用对应进程分配的ID做区分。</li></ul><p>保存这个子项目为tbj文件，如“voice_spec.tbj”。</p><h5 id="（2）-附加包装器"><a name="（2）-附加包装器" href="#（2）-附加包装器"></a>（2） 附加包装器</h5><p>把平台自带的包装器“subtask_warpper.exe”拷贝到“voice_spec.tbj”相同的文件夹，命名为“voice_spec.exe”</p><ul>
<li>voice_spec.exe 会自动读取 voice_spec.tbj，并告诉平台自己的接口。</li><li>在Linux下，没有exe扩展名。</li></ul><h5 id="（3）-附加默认模块加载脚本"><a name="（3）-附加默认模块加载脚本" href="#（3）-附加默认模块加载脚本"></a>（3） 附加默认模块加载脚本</h5><p>由于voice_spec需要自行加载模块，需要把 taskBusPlatform.exe 所在文件夹下的 default_mods.text 拷贝到“voice_spec.tbj”相同的文件夹，命名为“voice_spec.text”。</p><ul>
<li>由于平台的当前运行路径永远是 taskBusPlatform.exe 所在路径，因此，文件voice_spec.text中的相对路径仍旧与 default_mods.text 不变。用户不需要额外编辑。</li><li>但仍旧需要检视文件 文件voice_spec.text, 以便清除无用的条目。</li><li><strong>尤其需要注意，文件voice_spec.text中不能包含voice_spec模块的入口行。这样会导致递归加载，启动上百个子进程拖慢系统</strong></li></ul><p>完成2、3两个步骤后，文件夹看起来是这样的：</p><p><img src="images/subprj_folder.png" alt="subprj_folder"></p><p>文件voice_spec.text被修改为：</p><pre><code class="text" data-origin="<pre><code class=&quot;text&quot;>modules/source_soundcard.exe
modules/transform_fft.exe
</code></pre>">modules/source_soundcard.exe
modules/transform_fft.exe
</code></pre><h5 id="（4）载入子项目模块"><a name="（4）载入子项目模块" href="#（4）载入子项目模块"></a>（4）载入子项目模块</h5><p>在平台中载入子项目模块”voice_spec.exe”后，可以把该模块作为整体拖入设计区：</p><p><img src="images/subprj_emb.png" alt="subprj_emb"></p><ul>
<li>双击“voice_spec” 图标，会打开子项目。</li></ul><h3 id="4.5-多平台、分布式及扩展"><a name="4.5-多平台、分布式及扩展" href="#4.5-多平台、分布式及扩展"></a>4.5 多平台、分布式及扩展</h3><p>taskBus 核心采用 Qt 开发，是跨平台的结构框架，可以在支持Qt的所有平台上运行。同时，通过引入相应的模块，taskBus 可以较为方便地实现分布式计算。在代码示例中，含有基于TCP的点对点传输模块、接受SQL脚本的数据库记录模块。</p><p>taskBus除了支持使用 C++, C#, VB等编译型语言，还可以通过包装器直接引用 python，lua，perl，ruby，matlab 作为模块，非常灵活。</p><p>具体例子参考附带代码。</p><h2 id="5-关于taskbus"><a name="5-关于taskbus" href="#5-关于taskbus"></a>5 关于taskBus</h2><p><strong>版权保护与商业用途</strong></p><p>taskBus 本身是开放标准的软件体系，遵循LGPL协议，但不规定模块的许可类型。<br>若开发者发布的是商用模块，要自行完成注册认证、激活等功能设计。<br>TaskBus 由 goldenhawking studio 开发，欢迎活跃开发者加入！</p><p>邮箱：goldenhawking@163.com</p>

<footer style="position:fixed; font-size:.8em; text-align:right; bottom:0px; margin-left:-25px; height:20px; width:100%;">generated by <a href="http://pad.haroopress.com" target="_blank">haroopad</a></footer>
</body>
</html>
